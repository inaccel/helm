---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
  labels:
    {{- include "labels" $ | nindent 4 }}
  name: {{ $.Chart.Name }}
  namespace: {{ $.Release.Namespace }}
spec:
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: kubevirt-config
      labels:
        kind: Job
        {{- include "labels" $ | nindent 8 }}
    spec:
      containers:
      - args:
        - patch
        - --namespace=harvester-system
        - --patch={"spec":{"configuration":{"developerConfiguration":{"featureGates":["LiveMigration","HotplugVolumes","HostDevices"]},"permittedHostDevices":{"pciHostDevices":[{{ $comma := false }}{{ range $vendorId, $vendor := $.Values.fpga.vendors }}{{ range $deviceId, $device := $vendor.devices }}{{ if $comma }},{{ else }}{{ $comma = true }}{{end}}{"pciVendorSelector":"{{ $vendor.selector }}:{{ $device.selector }}","resourceName":"{{ $vendorId }}/{{ $deviceId }}"}{{ end }}{{ end }}]}}}}
        - --type=merge
        - kubevirt/kubevirt
        image: bitnami/kubectl
        name: kubevirt-config
      restartPolicy: Never
      serviceAccountName: {{ $.Chart.Name }}
